# ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

## ğŸ¯ å­¦ç¿’ç›®æ¨™

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®åŸºæœ¬æ¦‚å¿µã‚’ç†è§£ã™ã‚‹
- Cookie ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®é•ã„ã¨ä½¿ã„åˆ†ã‘ã‚’çŸ¥ã‚‹
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å®‰å…¨ãªç®¡ç†æ–¹æ³•ã‚’å­¦ã¶
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ç›£è¦–ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ã‚’ç†è§£ã™ã‚‹
- ãƒã‚±ãƒƒãƒˆãƒªã‚¹ãƒˆã‚¢ãƒ—ãƒªã§ã®å®Ÿè£…ã‚’è©³ã—ãåˆ†æã™ã‚‹

## ğŸ“ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨ã¯

### ğŸ¤” ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå¿…è¦ãªç†ç”±

HTTP ã¯ **ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹** ãªãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã™ï¼š

```
HTTP ã®ç‰¹å¾´:
ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€
ğŸŒ ã‚µãƒ¼ãƒãƒ¼: ã€ŒOKã€èªè¨¼ã—ã¾ã—ãŸã€

ï¼ˆæ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãŸã„ã§ã™ã€
ğŸŒ ã‚µãƒ¼ãƒãƒ¼: ã€Œã‚ãªãŸèª°ã§ã™ã‹ï¼Ÿã€ï¼ˆå‰ã®ã‚„ã‚Šå–ã‚Šã‚’è¦šãˆã¦ã„ãªã„ï¼‰
```

**ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†** ã«ã‚ˆã‚Šã€ã“ã®å•é¡Œã‚’è§£æ±ºã—ã¾ã™ï¼š

```
ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚ã‚Š:
ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€
ğŸŒ ã‚µãƒ¼ãƒãƒ¼: ã€ŒOKã€ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒã£ã¦ã„ã¦ãã ã•ã„ ğŸ«ã€

ï¼ˆæ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãŸã„ã§ã™ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ ğŸ« ã‚’æç¤ºï¼‰ã€
ğŸŒ ã‚µãƒ¼ãƒãƒ¼: ã€Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèª... ã‚ãªãŸã¯èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ã­ï¼ã€
```

## ğŸª ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜å ´æ‰€

### æ¯”è¼ƒè¡¨

| ä¿å­˜å ´æ‰€ | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | æœŸé™ | JavaScript ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ | ä½¿ç”¨ä¾‹ |
|----------|--------------|------|---------------------------|--------|
| **Cookie** | â­â­â­â­ | è¨­å®šå¯èƒ½ | HttpOnly ãªã‚‰ä¸å¯ | èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ |
| **localStorage** | â­â­ | æ°¸ç¶šçš„ | å¯èƒ½ | ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š |
| **sessionStorage** | â­â­ | ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹ã¾ã§ | å¯èƒ½ | ä¸€æ™‚çš„ãªãƒ‡ãƒ¼ã‚¿ |
| **ãƒ¡ãƒ¢ãƒª** | â­â­â­â­â­ | ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã¾ã§ | å¯èƒ½ | ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ |

### ğŸª Cookie ã®è©³ç´°

#### Cookie ã®å±æ€§

```typescript
// ã‚»ã‚­ãƒ¥ã‚¢ãª Cookie ã®è¨­å®šä¾‹
document.cookie = [
  `${name}=${value}`,
  'HttpOnly',           // XSSæ”»æ’ƒå¯¾ç­–: JavaScriptã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
  'Secure',             // HTTPSå¿…é ˆ
  'SameSite=Strict',    // CSRFæ”»æ’ƒå¯¾ç­–
  'Path=/',             // ã‚µã‚¤ãƒˆå…¨ä½“ã§æœ‰åŠ¹
  `Max-Age=${86400}`    // 24æ™‚é–“ã§æœŸé™åˆ‡ã‚Œ
].join('; ');
```

#### ãƒã‚±ãƒƒãƒˆãƒªã‚¹ãƒˆã‚¢ãƒ—ãƒªã§ã® Cookie ä½¿ç”¨

```typescript
// app/features/auth/lib/auth-context.tsx ã‚ˆã‚Š
const signOut = async () => {
  try {
    await supabase.auth.signOut();

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®å®Œå…¨ã‚¯ãƒªã‚¢
    if (typeof window !== "undefined") {
      try {
        // ğŸ” Cookieå‰Šé™¤ï¼ˆSupabaseèªè¨¼æƒ…å ±ï¼‰
        document.cookie.split(";").forEach((cookie) => {
          const [name] = cookie.split("=");
          if (name.trim().includes("supabase")) {
            document.cookie = `${name.trim()}=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT; SameSite=strict`;
          }
        });

        // ğŸ›¡ï¸ localStorage ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‰Šé™¤ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿å¯¾å¿œï¼‰
        Object.keys(localStorage).forEach((key) => {
          if (key.includes("supabase")) {
            localStorage.removeItem(key);
          }
        });
      } catch (error) {
        console.warn("Failed to clear session data:", error);
      }
    }
  } catch (error) {
    console.error("Unexpected sign out error:", error);
  }
};
```

## ğŸ”„ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«

```mermaid
stateDiagram-v2
    [*] --> æœªèªè¨¼
    æœªèªè¨¼ --> ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† : ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† --> èªè¨¼ä¸­ : èªè¨¼æƒ…å ±ã‚’é€ä¿¡
    èªè¨¼ä¸­ --> èªè¨¼æ¸ˆã¿ : èªè¨¼æˆåŠŸ
    èªè¨¼ä¸­ --> ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•— : èªè¨¼å¤±æ•—
    ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•— --> æœªèªè¨¼ : ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    
    èªè¨¼æ¸ˆã¿ --> ã‚¢ã‚¯ãƒ†ã‚£ãƒ– : åˆæœŸçŠ¶æ…‹
    ã‚¢ã‚¯ãƒ†ã‚£ãƒ– --> ã‚¢ã‚¯ãƒ†ã‚£ãƒ– : ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
    ã‚¢ã‚¯ãƒ†ã‚£ãƒ– --> éã‚¢ã‚¯ãƒ†ã‚£ãƒ– : ä¸€å®šæ™‚é–“æ“ä½œãªã—
    éã‚¢ã‚¯ãƒ†ã‚£ãƒ– --> æœŸé™åˆ‡ã‚Œ : ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    èªè¨¼æ¸ˆã¿ --> æœŸé™åˆ‡ã‚Œ : JWTæœ‰åŠ¹æœŸé™åˆ‡ã‚Œ
    æœŸé™åˆ‡ã‚Œ --> æœªèªè¨¼ : è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    
    èªè¨¼æ¸ˆã¿ --> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç† : ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç† --> æœªèªè¨¼ : ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤
```

## ğŸ• ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ç›£è¦–ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

### ğŸ“Š ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ç›£è¦–ã®å®Ÿè£…

ãƒã‚±ãƒƒãƒˆãƒªã‚¹ãƒˆã‚¢ãƒ—ãƒªã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã‚’ç›£è¦–ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ï¼š

```typescript
// app/features/auth/lib/auth-context.tsx ã‚ˆã‚Š
export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [lastActivity, setLastActivity] = useState<Date>(new Date());

  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£è¿½è·¡
  const updateActivity = useCallback(() => {
    setLastActivity(new Date());
  }, []);

  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šéã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
  useEffect(() => {
    if (!session || typeof window === "undefined") return;

    const checkInactivity = () => {
      const now = new Date();
      const timeSinceLastActivity = now.getTime() - lastActivity.getTime();
      const maxInactivity = 30 * 60 * 1000; // 30åˆ†

      if (timeSinceLastActivity > maxInactivity) {
        signOut();
      }
    };

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ç›£è¦–
    const activityEvents = [
      "mousedown",
      "mousemove", 
      "keypress",
      "scroll",
      "touchstart",
    ];

    const handleActivity = () => {
      updateActivity();
    };

    activityEvents.forEach((event) => {
      document.addEventListener(event, handleActivity, { passive: true });
    });

    // 5åˆ†ã”ã¨ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
    const inactivityCheck = setInterval(checkInactivity, 5 * 60 * 1000);

    return () => {
      activityEvents.forEach((event) => {
        document.removeEventListener(event, handleActivity);
      });
      clearInterval(inactivityCheck);
    };
  }, [session, lastActivity, updateActivity]);
}
```

### ğŸ” ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ç›£è¦–ã®æµã‚Œ

```mermaid
sequenceDiagram
    participant U as ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant D as ğŸ“„ DOM
    participant AM as â±ï¸ Activity Monitor
    participant SM as ğŸ›¡ï¸ Session Manager

    Note over U,SM: ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£æ¤œçŸ¥
    U->>D: ãƒã‚¦ã‚¹ç§»å‹•ãƒ»ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    D->>AM: ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
    AM->>AM: lastActivity æ›´æ–°
    
    Note over U,SM: å®šæœŸãƒã‚§ãƒƒã‚¯ï¼ˆ5åˆ†ã”ã¨ï¼‰
    loop 5åˆ†ã”ã¨
        SM->>AM: æœ€çµ‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£æ™‚åˆ»ã‚’ç¢ºèª
        AM-->>SM: lastActivity
        SM->>SM: ç¾åœ¨æ™‚åˆ» - lastActivity ã‚’è¨ˆç®—
        
        alt 30åˆ†ä»¥å†…ã®æ´»å‹•ã‚ã‚Š
            SM->>SM: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶š
        else 30åˆ†ä»¥ä¸Šéã‚¢ã‚¯ãƒ†ã‚£ãƒ–
            SM->>U: è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Ÿè¡Œ
            SM->>D: ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        end
    end
```

## ğŸ” ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼

### JWT ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ¤œè¨¼

```typescript
// app/features/auth/lib/auth-context.tsx ã‚ˆã‚Š
// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼
const validateSession = useCallback((session: Session | null): boolean => {
  if (!session) return false;

  // JWTã®æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
  const now = Math.floor(Date.now() / 1000);
  if (session.expires_at && session.expires_at < now) {
    console.warn("Session expired");
    return false;
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
  if (!session.user || !session.user.id || !session.user.email) {
    console.warn("Invalid user data in session");
    return false;
  }

  return true;
}, []);
```

### ğŸ• å®šæœŸçš„ãªã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼

```typescript
// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šèªè¨¼çŠ¶æ…‹å¤‰åŒ–ã®ç›£è¦–
const {
  data: { subscription },
} = supabase.auth.onAuthStateChange(async (event, session) => {
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼
  if (session && !validateSession(session)) {
    console.warn("Invalid session detected, signing out");
    await supabase.auth.signOut();
    return;
  }

  setSession(session);
  setUser(session?.user ?? null);
  setLoading(false);

  if (session) {
    updateActivity();
  }

  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šç‰¹å®šã‚¤ãƒ™ãƒ³ãƒˆã§ã®è¿½åŠ ãƒã‚§ãƒƒã‚¯
  if (event === "TOKEN_REFRESHED" && session) {
    // ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°æ™‚ã®æ¤œè¨¼
    if (!validateSession(session)) {
      console.warn("Token refresh resulted in invalid session");
      await supabase.auth.signOut();
    }
  }
});
```

## ğŸŒ ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

### SSR ã§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼

```typescript
// app/lib/auth-server.ts ã‚ˆã‚Š
export async function getServerAuth(request: Request): Promise<ServerAuthResult> {
  try {
    const cookieHeader = request.headers.get("Cookie") || "";
    const cookies = parseCookies(cookieHeader);

    // Extract Supabase tokens from cookies
    const { access_token, refresh_token, expires_at } = extractSupabaseTokens(cookies);

    // If no access token found, user is not authenticated
    if (!access_token) {
      return {
        user: null,
        isAuthenticated: false,
        session: null,
      };
    }

    // Check if token is expired
    if (isTokenExpired(expires_at)) {
      return {
        user: null,
        isAuthenticated: false,
        session: null,
      };
    }

    // Validate the JWT token and get user
    const user = await validateJwtToken(access_token);

    if (!user) {
      return {
        user: null,
        isAuthenticated: false,
        session: null,
      };
    }

    // Return successful authentication result
    return {
      user,
      isAuthenticated: true,
      session: {
        access_token,
        refresh_token: refresh_token || "",
        expires_at,
      },
    };
  } catch (error) {
    return {
      user: null,
      isAuthenticated: false,
      session: null,
    };
  }
}
```

### ğŸ” Cookie è§£æã®è©³ç´°

```typescript
// app/lib/auth-server.ts ã‚ˆã‚Š
function extractSupabaseTokens(cookies: Record<string, string>): {
  access_token: string | null;
  refresh_token: string | null;
  expires_at: number | null;
} {
  let access_token: string | null = null;
  let refresh_token: string | null = null;
  let expires_at: number | null = null;

  // Look for Supabase session data in cookies
  for (const [key, value] of Object.entries(cookies)) {
    if (key.includes("supabase") || key.startsWith("sb-")) {
      try {
        // Try to parse as JSON (Supabase stores session as JSON in cookies)
        const parsed = JSON.parse(value);

        if (parsed.access_token) {
          access_token = parsed.access_token;
        }
        if (parsed.refresh_token) {
          refresh_token = parsed.refresh_token;
        }
        if (parsed.expires_at) {
          expires_at = parsed.expires_at;
        }

        // If we found session data, break
        if (access_token && refresh_token) {
          break;
        }
      } catch {
        // If not JSON, check if it's a direct token
        if (value.length > 20 && (value.includes(".") || value.startsWith("ey"))) {
          // Looks like a JWT token
          if (key.includes("access") || key.includes("token")) {
            access_token = value;
          } else if (key.includes("refresh")) {
            refresh_token = value;
          }
        }
      }
    }
  }

  return { access_token, refresh_token, expires_at };
}
```

## ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

```typescript
// ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®ãƒ¡ãƒ¢åŒ–
const memoizedAuth = useMemo(() => ({
  user,
  session,
  loading,
  isAuthenticated: !!user,
}), [user, session, loading]);

// èªè¨¼ãƒã‚§ãƒƒã‚¯ã®æœ€é©åŒ–
const debouncedValidateSession = useCallback(
  debounce((session: Session | null) => {
    if (session) {
      validateSession(session);
    }
  }, 1000),
  [validateSession]
);
```

### ğŸ¯ èªè¨¼çŠ¶æ…‹ã®ä¸€å…ƒç®¡ç†

```typescript
// app/features/auth/lib/auth-context.tsx ã‚ˆã‚Š
const value = {
  user,
  session,
  loading,
  signIn,
  signUp,
  signOut,
};

return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
```

## ğŸ”„ ã‚»ãƒƒã‚·ãƒ§ãƒ³åŒæœŸ

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»ã‚µãƒ¼ãƒãƒ¼é–“ã§ã®çŠ¶æ…‹åŒæœŸ

```mermaid
sequenceDiagram
    participant C as ğŸ’» ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    participant S as ğŸ›¡ï¸ ã‚µãƒ¼ãƒãƒ¼
    participant DB as ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

    Note over C,DB: åˆæœŸåŒ–æ™‚ã®åŒæœŸ
    C->>S: ãƒšãƒ¼ã‚¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆCookieä»˜ãï¼‰
    S->>S: Cookie ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼
    S->>DB: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    DB-->>S: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
    S-->>C: åˆæœŸèªè¨¼çŠ¶æ…‹ + ãƒšãƒ¼ã‚¸HTML
    C->>C: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèªè¨¼çŠ¶æ…‹ã‚’åˆæœŸåŒ–

    Note over C,DB: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
    C->>S: API ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆJWTä»˜ãï¼‰
    S->>S: JWT æ¤œè¨¼
    alt JWT ãŒæœ‰åŠ¹
        S-->>C: ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    else JWT ãŒç„¡åŠ¹/æœŸé™åˆ‡ã‚Œ
        S-->>C: 401 Unauthorized
        C->>C: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†å®Ÿè¡Œ
        C->>S: ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    end
```

## ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

### 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šæ”»æ’ƒå¯¾ç­–

```typescript
// ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œã«ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å†ç”Ÿæˆ
const handleSuccessfulLogin = async (session: Session) => {
  // å¤ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
  clearOldSession();
  
  // æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’è¨­å®š
  setSession(session);
  setUser(session.user);
  
  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£è¨˜éŒ²
  updateActivity();
};
```

### 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯å¯¾ç­–

```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç›£è¦–
const validateSessionIntegrity = (session: Session) => {
  const storedUserAgent = localStorage.getItem('session.userAgent');
  const currentUserAgent = navigator.userAgent;
  
  if (storedUserAgent && storedUserAgent !== currentUserAgent) {
    console.warn('User agent changed, possible session hijacking');
    return false;
  }
  
  return true;
};
```

### 3. åŒæ™‚ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶é™

```typescript
// è¤‡æ•°ã‚¿ãƒ–ã§ã®åŒæ™‚ãƒ­ã‚°ã‚¤ãƒ³æ¤œçŸ¥
useEffect(() => {
  const handleStorageChange = (e: StorageEvent) => {
    if (e.key === 'supabase.auth.token') {
      if (e.newValue === null) {
        // ä»–ã®ã‚¿ãƒ–ã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã‚ŒãŸ
        signOut();
      } else if (e.newValue !== e.oldValue) {
        // ä»–ã®ã‚¿ãƒ–ã§æ–°ã—ã„ãƒ­ã‚°ã‚¤ãƒ³ãŒç™ºç”Ÿ
        location.reload();
      }
    }
  };

  window.addEventListener('storage', handleStorageChange);
  return () => window.removeEventListener('storage', handleStorageChange);
}, []);
```

## ğŸ“Š ã‚»ãƒƒã‚·ãƒ§ãƒ³ç›£è¦–ã¨ãƒ‡ãƒãƒƒã‚°

### ãƒ‡ãƒãƒƒã‚°ç”¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±è¡¨ç¤º

```typescript
// é–‹ç™ºç’°å¢ƒã§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒãƒƒã‚¬ãƒ¼
export function SessionDebugger() {
  const { user, session, loading } = useAuth();

  if (process.env.NODE_ENV !== 'development') return null;

  return (
    <div className="fixed bottom-4 right-4 bg-black text-white p-4 rounded text-xs max-w-sm">
      <h3 className="font-bold mb-2">Session Debug Info</h3>
      <div>Loading: {loading.toString()}</div>
      <div>User: {user?.email || 'none'}</div>
      <div>Session: {session ? 'active' : 'none'}</div>
      <div>Expires: {session?.expires_at ? new Date(session.expires_at * 1000).toLocaleString() : 'none'}</div>
      <div>Last Activity: {new Date().toLocaleString()}</div>
    </div>
  );
}
```

## ğŸ¯ é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

### âœ… è¦šãˆã¦ãŠãã¹ãã“ã¨

1. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ä¸€æ™‚çš„**: é©åˆ‡ãªæœŸé™è¨­å®šãŒé‡è¦
2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã®ãƒãƒ©ãƒ³ã‚¹**: é•·ã™ããšçŸ­ã™ããªã„æœŸé™
3. **è¤‡æ•°ã®æ¤œè¨¼ãƒ¬ã‚¤ãƒ¤ãƒ¼**: JWTæœŸé™ + ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ç›£è¦– + æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
4. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»ã‚µãƒ¼ãƒãƒ¼åŒæœŸ**: ä¸¡æ–¹ã§ä¸€è²«ã—ãŸèªè¨¼çŠ¶æ…‹ã‚’ç¶­æŒ

### âŒ ã‚ˆãã‚ã‚‹é–“é•ã„

```typescript
// âŒ æ‚ªã„ä¾‹: ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä¿¡ç”¨ã—ã™ã
function getUserData() {
  const user = localStorage.getItem('user');
  return JSON.parse(user); // æ¤œè¨¼ãªã—ã§ä½¿ç”¨
}

// âœ… è‰¯ã„ä¾‹: å¸¸ã«æ¤œè¨¼ã—ã¦ã‹ã‚‰ä½¿ç”¨
function getUserData() {
  const { user, session } = useAuth();
  
  if (!session || !validateSession(session)) {
    signOut();
    return null;
  }
  
  return user;
}
```

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ä»•çµ„ã¿ãŒç†è§£ã§ããŸã‚‰ã€æ¬¡ã¯ **[ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](./password-security.md)** ã§ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å®‰å…¨ãªå–ã‚Šæ‰±ã„ã«ã¤ã„ã¦å­¦ã³ã¾ã—ã‚‡ã†ã€‚

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥åŒ–ã€å¼·åº¦ãƒã‚§ãƒƒã‚¯ã€å®‰å…¨ãªä¿å­˜æ–¹æ³•ãªã©ã‚’å…·ä½“çš„ã«å­¦ç¿’ã—ã¾ã™ã€‚